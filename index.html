<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Task Bones ‚Äî Gamify-Ready</title>
<meta name="theme-color" content="#0f172a" />

<style>
  :root{
    --bg: #0b1020;
    --card:#121a33;
    --muted:#8fa1d0;
    --text:#e7ecff;
    --accent:#7c9bff;
    --accent-2:#3dd2c6;
    --danger:#ff6b6b;
    --warn:#ffb020;
    --border:#1f2a4d;
    --shadow: 0 8px 24px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    --radius:14px;
    --radius-sm:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b1020 0%, #0b1226 100%);
    color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  .app{height:100dvh; display:grid; grid-template-rows:auto 1fr auto;}
  header{
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(8px);
    background:linear-gradient(180deg, rgba(16,24,48,.9), rgba(16,24,48,.6));
    border-bottom:1px solid var(--border); padding:10px 14px; display:flex; align-items:center; gap:10px;
  }
  header h1{font-size:18px; margin:0; letter-spacing:.3px}
  .pill{
    margin-left:auto; display:inline-flex; gap:8px; align-items:center; font-size:12px;
    background:rgba(124,155,255,.15); color:var(--accent); padding:6px 10px; border-radius:999px; border:1px solid rgba(124,155,255,.25)
  }
  .pill .dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
  main{overflow:auto; padding:14px; padding-bottom:84px}
  .tabview{display:none}
  .tabview.active{display:block; animation:fade .18s ease-out}
  @keyframes fade{from{opacity:.6;transform:translateY(4px)} to{opacity:1;transform:none}}

  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
  .section{padding:14px; margin-bottom:14px}
  .section h2{margin:0 0 12px; font-size:16px; color:#cfe0ff}
  .row{display:flex; gap:10px}
  .row.wrap{flex-wrap:wrap}
  .row > *{flex:1}
  .input, select, button, textarea{
    width:100%; background:#0e1530; color:var(--text); border:1px solid var(--border);
    border-radius:var(--radius-sm); padding:12px; font-size:14px; outline:none;
  }
  textarea{min-height:72px; resize:vertical}
  select{appearance:none; background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%),
                              linear-gradient(135deg, var(--muted) 50%, transparent 50%),
                              linear-gradient(to right, #0000, #0000);
         background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px), 100% 0;
         background-size:6px 6px, 6px 6px, 2.5em 2.5em; background-repeat:no-repeat}
  label.small{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    border-radius:12px; padding:12px 14px; font-weight:600; cursor:pointer; user-select:none;
    border:1px solid var(--border); background:#0f1835; color:#fff;
  }
  .btn.primary{background:linear-gradient(180deg, #5c7dff, #5575f1); border:0}
  .btn.ghost{background:transparent}
  .btn.warn{background:linear-gradient(180deg,#ffb020,#ff9b00); color:#241400; border:0}
  .btn.danger{background:linear-gradient(180deg,#ff6b6b,#ff4d4d); border:0}
  .btn:active{transform:translateY(1px)}
  .chip{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#0e1530; font-size:12px}
  .chip input{margin:0}
  .grid{display:grid; gap:10px}
  .two{grid-template-columns: 1fr 1fr}
  .three{grid-template-columns: repeat(3, 1fr)}
  .list{display:flex; flex-direction:column; gap:10px}
  .task{
    padding:12px; border-radius:12px; border:1px solid var(--border); background:#0e1530; display:grid; gap:6px;
  }
  .task .top{display:flex; align-items:center; gap:10px}
  .task .title{font-weight:700}
  .badge{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1835; color:#cfe0ff}
  .cat-Home{--b:#7c9bff}.cat-Fitness{--b:#3dd2c6}.cat-Finance{--b:#eab308}.cat-Skills{--b:#fb7185}.cat-Work{--b:#a78bfa}.cat-Rose{--b:#f472b6}.cat-Other{--b:#94a3b8}
  .badge.cat{border-color:var(--b); color:var(--b); background:color-mix(in hsl, var(--b) 14%, transparent)}
  .badge.low{color:#67e8f9; border-color:#164e63; background:#072026}
  .badge.med{color:#fde68a; border-color:#4d3a14; background:#241a06}
  .badge.high{color:#fecaca; border-color:#5b1111; background:#260707}
  .muted{color:var(--muted); font-size:12px}
  .task .actions{display:flex; gap:8px; margin-top:6px}
  .task.done{opacity:.66; filter:saturate(.8)}
  .task.done .title{text-decoration:line-through}

  /* Calendar */
  .cal{background:#0d142b; border:1px solid var(--border); border-radius:var(--radius); overflow:hidden}
  .cal .cal-head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border)}
  .cal .cal-grid{display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background:var(--border)}
  .cal .dow, .cal .cell{background:#0e1530; min-height:64px}
  .cal .dow{font-size:11px; color:#9fb1e6; display:flex; align-items:center; justify-content:center; padding:8px 0}
  .cal .cell{padding:6px; display:flex; flex-direction:column; gap:6px}
  .cal .cell .d{font-size:12px; color:#abc; font-weight:700; display:flex; align-items:center; gap:6px}
  .cal .cell.today{outline:2px solid var(--accent); outline-offset:-2px}
  .cal .cell.other{opacity:.45}
  /* Compact preview row: category dots + count */
  .pv-row{display:flex; align-items:center; gap:6px; flex-wrap:wrap}
  .dotcat{width:12px;height:12px;border-radius:3px; background:var(--b,#5c7dff); border:1px solid rgba(0,0,0,.25); position:relative}
  .dotcat i{position:absolute; inset:auto -6px -8px auto; font-style:normal; font-size:9px; color:#bcd; opacity:.9}
  .pv-count{margin-left:auto; font-size:11px; color:#cde; background:#0f1835; border:1px solid var(--border); padding:2px 6px; border-radius:999px}
  .pv-rec{font-size:10px; opacity:.75}
  .cal .legend{display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:#0d142b; flex-wrap:wrap}
  .legend .it{display:flex; align-items:center; gap:6px; font-size:12px; color:#a8b5e4}
  .legend .dot{width:10px;height:10px;border-radius:2px; background:#4158d0}

  /* Stats */
  .stats-grid{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}
  .stat{padding:12px; border-radius:12px; border:1px solid var(--border); background:#0e1530;}
  .stat .n{font-size:22px; font-weight:800}
  .progress{height:8px; background:#111a36; border-radius:999px; overflow:hidden; border:1px solid #1a254b}
  .progress > i{display:block; height:100%; background:linear-gradient(90deg,#5c7dff,#3dd2c6)}

  /* Tabs */
  nav{
    position:fixed; z-index:20; bottom:0; left:0; right:0; background:rgba(10,15,32,.9);
    backdrop-filter: blur(10px) saturate(120%);
    border-top:1px solid var(--border); display:grid; grid-template-columns: repeat(4, 1fr);
  }
  nav button{
    padding:10px 8px; background:transparent; border:0; color:#cbd5ff; font-weight:700; font-size:13px;
    display:flex; flex-direction:column; align-items:center; gap:4px;
  }
  nav button.active{color:var(--accent)}
  nav .ico{font-size:18px; line-height:1}
  .sp{height:72px}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55)}
  .modal.show{display:flex}
  .sheet{width:min(680px, 92vw); max-height:80vh; overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
  .sheet .hd{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border)}
  .sheet .bd{padding:12px 14px}

  @media (min-width:880px){
    main{padding:18px 18px 96px}
    .stats-grid{grid-template-columns: repeat(4, 1fr)}
    .grid.two{grid-template-columns: 1fr 1fr}
  }

  /* === FIX: Wrap long task titles (Tasks & Modal) === */
  .task .top{
    align-items:flex-start;
    flex-wrap:wrap;
    gap:10px 8px;
  }
  .task .top > input[type="checkbox"]{
    flex:0 0 auto;
    margin-top:2px;
  }
  .task .title{
    flex:1 1 180px;
    min-width:0;
    white-space:normal;
    overflow-wrap:anywhere;
    word-break:break-word;
    line-height:1.25;
  }
  .task .top .badge{
    white-space:nowrap;
    flex:0 0 auto;
  }
  @media (max-width:420px){
    .task .actions .btn{ padding:10px 12px; }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Task Bones</h1>
    <span class="pill" id="pillTotals"><span class="dot"></span><span>Total Completed: 0</span></span>
  </header>

  <main>
    <!-- TASKS TAB -->
    <section class="tabview active" id="tab-tasks">
      <div class="section card">
        <h2>Add / Edit Task</h2>
        <form id="taskForm" class="grid two">
          <div>
            <label class="small">Title</label>
            <input class="input" required id="f_title" placeholder="e.g., 30-min run">
          </div>
          <div>
            <label class="small">Category</label>
            <select id="f_cat" required>
              <option>Home</option><option>Fitness</option><option>Finance</option>
              <option>Skills</option><option>Work</option><option>Rose</option><option>Other</option>
            </select>
          </div>
          <div>
            <label class="small">Priority</label>
            <select id="f_pri" required>
              <option>Low</option><option selected>Medium</option><option>High</option>
            </select>
          </div>
          <div>
            <label class="small">Due Date</label>
            <input class="input" id="f_due" type="date">
          </div>
          <div>
            <label class="small">Recurrence</label>
            <select id="f_rec">
              <option value="none" selected>None</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div>
            <label class="small">Estimated Effort (mins)</label>
            <input class="input" id="f_effort" type="number" min="0" step="5" placeholder="optional">
          </div>
          <div class="grid" style="grid-column:1 / -1">
            <label class="small">Notes</label>
            <textarea id="f_notes" placeholder="Details, links, etc."></textarea>
          </div>
          <input type="hidden" id="f_id">
          <div class="row" style="grid-column:1 / -1; justify-content:flex-end; gap:10px">
            <button type="button" class="btn ghost" id="btnResetForm">Clear</button>
            <button class="btn primary" id="btnSaveTask">Save Task</button>
          </div>
        </form>
      </div>

      <div class="section card">
        <h2>Filter</h2>
        <div class="row wrap">
          <select id="fl_cat"><option value="">All Categories</option>
            <option>Home</option><option>Fitness</option><option>Finance</option>
            <option>Skills</option><option>Work</option><option>Rose</option><option>Other</option>
          </select>
          <select id="fl_pri"><option value="">All Priorities</option>
            <option>Low</option><option>Medium</option><option>High</option>
          </select>
          <!-- NEW: Date filter -->
          <select id="fl_date" title="Filter by due date">
            <option value="">All Dates</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="unassigned">Unassigned</option>
          </select>
          <input class="input" id="fl_q" placeholder="Search title/notes">
        </div>
      </div>

      <div class="section card">
        <h2>Tasks</h2>
        <div class="list" id="taskList"></div>
      </div>
      <div class="sp"></div>
    </section>

    <!-- CALENDAR TAB -->
    <section class="tabview" id="tab-calendar">
      <div class="section card">
        <h2>Calendar</h2>
        <div class="row" style="align-items:center; gap:8px; margin-bottom:8px">
          <span class="chip"><input type="checkbox" id="cal_hide_rec" /> Hide recurring</span>
          <span class="chip"><input type="checkbox" id="cal_only_cat_chk" /> Filter by category</span>
          <select id="cal_cat" disabled>
            <option>Home</option><option>Fitness</option><option>Finance</option>
            <option>Skills</option><option>Work</option><option>Rose</option><option>Other</option>
          </select>
        </div>
        <div class="cal" id="calendar"></div>
      </div>
      <div class="sp"></div>
    </section>

    <!-- STATS TAB -->
    <section class="tabview" id="tab-stats">
      <div class="section card">
        <h2>At a Glance</h2>
        <div class="stats-grid" id="statsTop"></div>
      </div>

      <div class="section card">
        <h2>Per-Category Breakdown</h2>
        <div class="list" id="statsCats"></div>
      </div>
      <div class="sp"></div>
    </section>

    <!-- SETTINGS TAB -->
    <section class="tabview" id="tab-settings">
      <div class="section card">
        <h2>Data</h2>
        <div class="row">
          <button class="btn" id="btnExport">Export JSON</button>
          <label class="btn" style="cursor:pointer">
            Import JSON
            <input type="file" id="fileImport" accept="application/json" style="display:none">
          </label>
          <button class="btn warn" id="btnRebuild">Rebuild Stats</button>
          <button class="btn danger" id="btnReset">Reset All</button>
        </div>
        <p class="muted" style="margin-top:8px">Export includes tasks, completions, and computed stats. Import replaces current data.</p>
      </div>

      <div class="section card">
        <h2>Preferences</h2>
        <label class="chip"><input type="checkbox" id="set_hide_rec" /> Default: hide recurring in Calendar</label>
      </div>

      <div class="section card">
        <h2>About</h2>
        <p class="muted">This skeleton is designed for gamification extensions (streaks, badges, leveling). All core data lives in localStorage and works offline.</p>
      </div>
      <div class="sp"></div>
    </section>
  </main>

  <nav>
    <button class="active" data-tab="tasks"><span class="ico">‚úÖ</span><span>Tasks</span></button>
    <button data-tab="calendar"><span class="ico">üìÖ</span><span>Calendar</span></button>
    <button data-tab="stats"><span class="ico">üìà</span><span>Stats</span></button>
    <button data-tab="settings"><span class="ico">‚öôÔ∏è</span><span>Settings</span></button>
  </nav>
</div>

<!-- Day Modal -->
<div class="modal" id="dayModal" role="dialog" aria-modal="true" aria-labelledby="dayTitle">
  <div class="sheet">
    <div class="hd">
      <strong id="dayTitle">Day</strong>
      <button class="btn ghost" id="closeModal">Close</button>
    </div>
    <div class="bd">
      <div class="list" id="dayTasks"></div>
    </div>
  </div>
</div>

<script>
/* ========= Storage & Model ========= */
const STORAGE_KEY = 'taskbones.v3'; // timezone-safe + compact calendar
const CATS = ["Home","Fitness","Finance","Skills","Work","Rose","Other"];
const PRI_WEIGHTS = { Low:1, Medium:2, High:3 };

let db = loadDB();

/* ========= Date helpers (LOCAL, timezone-safe) ========= */
function toYMDLocal(date){
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,'0');
  const d = String(date.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function dateFromYMD(ymd){
  const [y,m,d] = (ymd||'').split('-').map(Number);
  if(!y||!m||!d) return null;
  return new Date(y, (m||1)-1, d||1);
}
function todayYMD(){ return toYMDLocal(new Date()); }
function startOfWeekYMD(base=new Date()){ // Monday-start
  const d = new Date(base);
  const day = (d.getDay()+6)%7; // 0 for Monday
  d.setDate(d.getDate()-day);
  return toYMDLocal(d);
}
function endOfWeekYMD(base=new Date()){
  const d = dateFromYMD(startOfWeekYMD(base));
  d.setDate(d.getDate()+6);
  return toYMDLocal(d);
}
function monthSpanYMD(base=new Date()){
  const a = new Date(base.getFullYear(), base.getMonth(), 1);
  const b = new Date(base.getFullYear(), base.getMonth()+1, 0);
  return [toYMDLocal(a), toYMDLocal(b)];
}
function fmtDate(ymd){ if(!ymd) return ''; const d=dateFromYMD(ymd); return d? d.toLocaleDateString():''; }
function compareDateYMD(a,b){ return a===b; }

/* ========= DB ========= */
function defaultDB(){
  return {
    tasks: [],
    stats: {
      totalCompleted: 0,
      byCategory: Object.fromEntries(CATS.map(c=>[c,{ Low:0, Medium:0, High:0, score:0 }]))
    },
    settings: {
      hideRecurringInCalendar: false
    }
  };
}
function saveDB(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); refreshUI(); }
function loadDB(){
  const candidates = [STORAGE_KEY, 'taskbones.v2', 'taskbones.v1'];
  for(const k of candidates){
    const raw = localStorage.getItem(k);
    if(!raw) continue;
    try{
      const parsed = JSON.parse(raw);
      for(const c of CATS){
        if(!parsed.stats.byCategory[c]) parsed.stats.byCategory[c] = {Low:0,Medium:0,High:0,score:0};
        if(parsed.stats.byCategory[c].low){
          const {low,medium,high,score} = parsed.stats.byCategory[c];
          parsed.stats.byCategory[c] = {Low:low||0, Medium:medium||0, High:high||0, score:score||0};
        }
      }
      if(parsed.settings?.hideRecurringInCalendar == null) parsed.settings.hideRecurringInCalendar=false;
      if(k!==STORAGE_KEY) localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
      return parsed;
    }catch(e){ console.warn('DB load error', e); }
  }
  return defaultDB();
}

/* ========= Helpers ========= */
const $ = sel => document.querySelector(sel);
function uid(){ return 't_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36); }
function clone(o){ return JSON.parse(JSON.stringify(o)); }
function escapeHTML(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m])); }

/* ========= Task CRUD ========= */
function upsertTask(data){
  const now = new Date().toISOString();
  if(data.id){
    const idx = db.tasks.findIndex(t=>t.id===data.id);
    if(idx>=0){ db.tasks[idx] = { ...db.tasks[idx], ...data }; }
  }else{
    data.id = uid();
    db.tasks.push({
      id:data.id, title:data.title.trim(), category:data.category, priority:data.priority,
      due:data.due||'', recurrence:data.recurrence||'none', notes:data.notes||'',
      effort:data.effort||0, doneAt:null, createdAt:now, history:[]
    });
  }
  saveDB();
}
function deleteTask(id){ db.tasks = db.tasks.filter(t=>t.id!==id); saveDB(); }
function toggleDone(id){
  const t = db.tasks.find(x=>x.id===id); if(!t) return;
  if(t.doneAt){
    const last = t.history.pop(); t.doneAt=null;
    if(last){ adjustStats(t.category, t.priority, -1); }
  }else{
    const when = new Date().toISOString(); t.doneAt=when;
    t.history.push({doneAt: when, snapshot:{cat:t.category, pri:t.priority}});
    adjustStats(t.category, t.priority, +1);
  }
  saveDB();
}
function adjustStats(cat, pri, delta){
  db.stats.totalCompleted += delta;
  const bucket = db.stats.byCategory[cat];
  bucket[pri] += delta;
  bucket.score += (PRI_WEIGHTS[pri]||1)*delta;
  if(db.stats.totalCompleted<0) db.stats.totalCompleted=0;
  for(const c of CATS){
    for(const p of ["Low","Medium","High"]){
      if(db.stats.byCategory[c][p]<0) db.stats.byCategory[c][p]=0;
    }
    if(db.stats.byCategory[c].score<0) db.stats.byCategory[c].score=0;
  }
}

/* ========= Filters ========= */
function dateFilterMatch(task, mode){
  const due = task.due || '';
  if(mode==='unassigned') return !due;

  if(!mode || mode==='') return true; // All Dates
  if(!due) return false;

  const t = dateFromYMD(due); if(!t) return false;
  const today = new Date();
  const ymd = toYMDLocal(t);

  if(mode==='today'){
    return compareDateYMD(ymd, todayYMD());
  }
  if(mode==='week'){
    const start = startOfWeekYMD(today);
    const end = endOfWeekYMD(today);
    return ymd >= start && ymd <= end;
  }
  if(mode==='month'){
    const [start,end] = monthSpanYMD(today);
    return ymd >= start && ymd <= end;
  }
  return true;
}

function applyTaskFilters(list){
  const cat = $('#fl_cat').value;
  const pri = $('#fl_pri').value;
  const dateMode = $('#fl_date').value; // NEW
  const q = $('#fl_q').value.trim().toLowerCase();
  return list.filter(t=>{
    if(cat && t.category!==cat) return false;
    if(pri && t.priority!==pri) return false;
    if(dateMode && !dateFilterMatch(t, dateMode)) return false;
    if(q && !(t.title.toLowerCase().includes(q) || t.notes.toLowerCase().includes(q))) return false;
    return true;
  });
}

/* ========= Rendering ========= */
function renderTasks(){
  const list = applyTaskFilters(db.tasks.slice().sort((a,b)=>{
    const ad = a.doneAt ? 1 : 0, bd = b.doneAt ? 1 : 0;
    if(ad!==bd) return ad-bd; // incomplete first
    const aDue = a.due||'9999-12-31', bDue = b.due||'9999-12-31';
    return aDue.localeCompare(bDue);
  }));
  const container = $('#taskList');
  container.innerHTML = '';
  if(list.length===0){
    container.innerHTML = `<div class="muted">No tasks match the current filter.</div>`;
    return;
  }
  for(const t of list){
    const el = document.createElement('div');
    el.className = 'task' + (t.doneAt?' done':'');
    el.innerHTML = `
      <div class="top">
        <input type="checkbox" ${t.doneAt?'checked':''} data-act="toggle" data-id="${t.id}">
        <div class="title">${escapeHTML(t.title)}</div>
        <span class="badge cat cat-${t.category}">${t.category}</span>
        <span class="badge ${t.priority==='Low'?'low':t.priority==='High'?'high':'med'}">${t.priority}</span>
        ${t.due ? `<span class="badge">Due ${fmtDate(t.due)}</span>`:''}
        ${t.recurrence!=='none' ? `<span class="badge">‚Üª ${t.recurrence}</span>`:''}
      </div>
      ${t.notes ? `<div class="muted">${escapeHTML(t.notes)}</div>`:''}
      <div class="actions">
        <button class="btn" data-act="edit" data-id="${t.id}">Edit</button>
        <button class="btn danger" data-act="del" data-id="${t.id}">Delete</button>
      </div>
    `;
    container.appendChild(el);
  }
}

/* ========= Stats ========= */
function renderStats(){
  $('#pillTotals').lastElementChild.textContent = 'Total Completed: ' + db.stats.totalCompleted;

  const top = $('#statsTop'); top.innerHTML = '';
  const low= sumCatPri('Low'), med=sumCatPri('Medium'), high=sumCatPri('High');
  top.appendChild(statCard('Completed (Low)', low));
  top.appendChild(statCard('Completed (Medium)', med));
  top.appendChild(statCard('Completed (High)', high));
  const totalScore = CATS.reduce((a,c)=>a+db.stats.byCategory[c].score,0);
  top.appendChild(statCard('Total Score', totalScore));

  const cats = $('#statsCats'); cats.innerHTML='';
  for(const c of CATS){
    const b = db.stats.byCategory[c];
    const sum = b.Low + b.Medium + b.High;
    const sc = b.score;
    const el = document.createElement('div');
    el.className='stat';
    const pct = totalScore ? Math.round((sc/totalScore)*100) : 0;
    el.innerHTML = `
      <div class="row" style="align-items:baseline; justify-content:space-between">
        <div style="font-weight:800">${c}</div>
        <div class="muted">Score: <b>${sc}</b> ‚Ä¢ Completed: <b>${sum}</b></div>
      </div>
      <div class="row" style="margin:8px 0 6px; gap:6px">
        <span class="badge low">Low: ${b.Low}</span>
        <span class="badge">Med: ${b.Medium}</span>
        <span class="badge high">High: ${b.High}</span>
      </div>
      <div class="progress"><i style="width:${pct}%"></i></div>
      <div class="muted" style="margin-top:6px">${pct}% of total score</div>
    `;
    cats.appendChild(el);
  }

  function statCard(label, n){
    const d = document.createElement('div');
    d.className='stat';
    d.innerHTML = `<div class="muted">${label}</div><div class="n">${n}</div>`;
    return d;
  }
  function sumCatPri(pri){ return CATS.reduce((a,c)=>a+db.stats.byCategory[c][pri],0); }
}

/* ========= Calendar ========= */
let calCursor = new Date(); // current month pointer

function renderCalendar(){
  const hideRec = $('#cal_hide_rec').checked;
  const filterByCat = $('#cal_only_cat_chk').checked ? $('#cal_cat').value : null;

  const wrap = $('#calendar');
  wrap.innerHTML = '';
  const head = document.createElement('div');
  head.className='cal-head';
  const monthLabel = calCursor.toLocaleString(undefined,{month:'long', year:'numeric'});
  head.innerHTML = `
    <button class="btn" id="cal_prev">&larr;</button>
    <div style="font-weight:800">${monthLabel}</div>
    <button class="btn" id="cal_next">&rarr;</button>
  `;
  wrap.appendChild(head);

  const grid = document.createElement('div');
  grid.className='cal-grid';
  const dows = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  for(const d of dows){ const a=document.createElement('div'); a.className='dow'; a.textContent=d; grid.appendChild(a); }

  const first = new Date(calCursor.getFullYear(), calCursor.getMonth(), 1);
  const start = new Date(first);
  const dayOffset = (first.getDay()+6)%7; // Monday-first
  start.setDate(first.getDate()-dayOffset);

  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const ymd = toYMDLocal(d); // local YMD, no UTC shift
    const cell = document.createElement('div'); cell.className='cell';
    if(d.getMonth()!==calCursor.getMonth()) cell.classList.add('other');
    const today = new Date(); if(toYMDLocal(d)===toYMDLocal(today)) cell.classList.add('today');

    const items = projectTasksForDay(ymd, hideRec, filterByCat);
    const sum = summarizeDay(items);

    const header = document.createElement('div');
    header.className='d';
    header.innerHTML = `${d.getDate()} ${sum.hasRec ? '<span class="pv-rec">‚Üª</span>' : ''}`;
    cell.appendChild(header);

    if(sum.total>0){
      const pv = document.createElement('div');
      pv.className='pv-row';
      const topCats = sum.byCatArray.slice(0,4);
      topCats.forEach(it=>{
        const dot = document.createElement('span');
        dot.className='dotcat cat-'+it.cat;
        dot.title = `${it.cat}: ${it.count}`;
        const num = document.createElement('i');
        if(it.count>1) num.textContent = it.count;
        dot.appendChild(num);
        pv.appendChild(dot);
      });
      if(sum.byCatArray.length>4){
        const more = document.createElement('span');
        more.className='pv-count';
        const remaining = sum.byCatArray.slice(4).reduce((a,b)=>a+b.count,0);
        more.textContent = `+${remaining}`;
        pv.appendChild(more);
      }else{
        const total = document.createElement('span');
        total.className='pv-count';
        total.textContent = `${sum.total}`;
        pv.appendChild(total);
      }
      cell.appendChild(pv);
    }

    cell.addEventListener('click',()=>openDayModal(ymd, items));
    grid.appendChild(cell);
  }
  wrap.appendChild(grid);

  const legend = document.createElement('div');
  legend.className='legend';
  legend.innerHTML = `
    <span class="it"><span class="dot" style="background:#5c7dff"></span> Category color</span>
    <span class="it">Number bubble = total tasks that day</span>
    <span class="it">‚Üª = has recurring items</span>`;
  wrap.appendChild(legend);

  $('#cal_prev').onclick = ()=>{ calCursor.setMonth(calCursor.getMonth()-1); renderCalendar(); };
  $('#cal_next').onclick = ()=>{ calCursor.setMonth(calCursor.getMonth()+1); renderCalendar(); };
}

function summarizeDay(items){
  const map = new Map(); let hasRec=false;
  for(const t of items){
    map.set(t.category, (map.get(t.category)||0)+1);
    if(t.recurrence && t.recurrence!=='none') hasRec=true;
  }
  const byCatArray = Array.from(map, ([cat,count])=>({cat,count}))
    .sort((a,b)=>b.count-a.count || a.cat.localeCompare(b.cat));
  return { total: items.length, hasRec, byCatArray };
}

function projectTasksForDay(ymd, hideRecurring, onlyCat){
  const res = [];
  for(const t of db.tasks){
    if(onlyCat && t.category!==onlyCat) continue;
    const isRec = t.recurrence && t.recurrence!=='none';
    if(isRec){
      if(hideRecurring) continue;
      if(!t.due) continue;
      const start = dateFromYMD(t.due);
      const check = dateFromYMD(ymd);
      if(!start||!check) continue;
      if(t.recurrence==='daily'){
        if(check >= start) res.push(t);
      }else if(t.recurrence==='weekly'){
        if(check >= start && start.getDay()===check.getDay()) res.push(t);
      }else if(t.recurrence==='monthly'){
        if(check >= start && start.getDate()===check.getDate()) res.push(t);
      }
    }else{
      if(t.due && compareDateYMD(t.due, ymd)) res.push(t);
    }
  }
  return res;
}

function openDayModal(ymd, items){
  const d = dateFromYMD(ymd);
  $('#dayTitle').textContent = d? d.toLocaleDateString(undefined,{weekday:'long', month:'long', day:'numeric', year:'numeric'}) : 'Day';
  const wrap = $('#dayTasks'); wrap.innerHTML='';
  if(items.length===0){ wrap.innerHTML = `<div class="muted">No tasks for this day.</div>`; }
  for(const t of items){
    const el = document.createElement('div');
    el.className='task' + (t.doneAt?' done':'');
    el.innerHTML = `
      <div class="top">
        <div class="title">${escapeHTML(t.title)}</div>
        <span class="badge cat cat-${t.category}">${t.category}</span>
        <span class="badge ${t.priority==='Low'?'low':t.priority==='High'?'high':'med'}">${t.priority}</span>
        ${t.recurrence!=='none' ? `<span class="badge">‚Üª ${t.recurrence}</span>`:''}
      </div>
      ${t.notes ? `<div class="muted">${escapeHTML(t.notes)}</div>`:''}
      <div class="actions">
        <button class="btn" data-act="edit" data-id="${t.id}">Edit</button>
        <button class="btn" data-act="jump" data-id="${t.id}">Select in Tasks</button>
      </div>
    `;
    wrap.appendChild(el);
  }
  $('#dayModal').classList.add('show');
}

/* ========= UI Wiring ========= */
function refreshUI(){
  renderTasks();
  renderStats();
  renderCalendar();
  $('#set_hide_rec').checked = !!db.settings.hideRecurringInCalendar;
  $('#cal_hide_rec').checked = !!db.settings.hideRecurringInCalendar;
}
function clearForm(){ $('#f_id').value = ''; $('#taskForm').reset(); }
$('#btnResetForm').onclick = clearForm;

$('#btnSaveTask').addEventListener('click', (e)=>{
  e.preventDefault();
  const data = {
    id: $('#f_id').value || undefined,
    title: $('#f_title').value,
    category: $('#f_cat').value,
    priority: $('#f_pri').value,
    due: $('#f_due').value,
    recurrence: $('#f_rec').value,
    notes: $('#f_notes').value,
    effort: parseInt($('#f_effort').value||'0',10)
  };
  if(!data.title.trim()) return alert('Please enter a title.');
  upsertTask(data);
  clearForm();
});

$('#taskList').addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-act]'); if(!btn) return;
  const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
  if(act==='del'){
    if(confirm('Delete this task?')) deleteTask(id);
  }else if(act==='edit'){
    const t = db.tasks.find(x=>x.id===id); if(!t) return;
    $('#f_id').value = t.id; $('#f_title').value = t.title; $('#f_cat').value = t.category;
    $('#f_pri').value = t.priority; $('#f_due').value = t.due || ''; $('#f_rec').value = t.recurrence || 'none';
    $('#f_notes').value = t.notes || ''; $('#f_effort').value = t.effort || '';
    document.querySelector('nav button[data-tab="tasks"]').click();
  }else if(act==='toggle'){ toggleDone(id); }
});

/* Filters UI */
// REMOVE the old line like:
// $('#fl_cat,#fl_pri,#fl_q,#fl_date').addEventListener('input', renderTasks);

// ADD this instead:
document.querySelectorAll('#fl_cat,#fl_pri,#fl_date')
  .forEach(el => el.addEventListener('change', renderTasks));

document.querySelector('#fl_q')
  .addEventListener('input', renderTasks);

/* Calendar controls */
$('#cal_hide_rec').addEventListener('change', ()=>{
  db.settings.hideRecurringInCalendar = $('#cal_hide_rec').checked;
  saveDB();
});
$('#cal_only_cat_chk').addEventListener('change', (e)=>{
  $('#cal_cat').disabled = !e.target.checked;
  renderCalendar();
});
$('#cal_cat').addEventListener('change', renderCalendar);

/* Modal */
$('#closeModal').onclick = ()=>$('#dayModal').classList.remove('show');
$('#dayModal').addEventListener('click',(e)=>{ if(e.target.id==='dayModal') $('#dayModal').classList.remove('show'); });
$('#dayTasks').addEventListener('click',(e)=>{
  const btn = e.target.closest('[data-act]'); if(!btn) return;
  const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
  if(act==='edit'){
    const t = db.tasks.find(x=>x.id===id); if(!t) return;
    $('#f_id').value = t.id; $('#f_title').value = t.title; $('#f_cat').value = t.category;
    $('#f_pri').value = t.priority; $('#f_due').value = t.due || ''; $('#f_rec').value = t.recurrence || 'none';
    $('#f_notes').value = t.notes || ''; $('#f_effort').value = t.effort || '';
    document.querySelector('nav button[data-tab="tasks"]').click();
    $('#dayModal').classList.remove('show');
  }else if(act==='jump'){
    document.querySelector('nav button[data-tab="tasks"]').click();
    const node = [...document.querySelectorAll('#taskList .task')].find(n=>n.querySelector(`[data-id="${id}"]`));
    if(node){ node.scrollIntoView({behavior:'smooth', block:'center'}); node.style.outline='2px solid var(--accent)'; setTimeout(()=>node.style.outline='none',1400); }
    $('#dayModal').classList.remove('show');
  }
});

/* Tabs */
document.querySelectorAll('nav button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    document.querySelectorAll('.tabview').forEach(v=>v.classList.remove('active'));
    document.querySelector('#tab-'+tab).classList.add('active');
    if(tab==='calendar') renderCalendar();
    if(tab==='stats') renderStats();
  });
});

/* Settings */
$('#set_hide_rec').addEventListener('change', ()=>{
  db.settings.hideRecurringInCalendar = $('#set_hide_rec').checked;
  saveDB();
});

/* Import / Export / Reset / Rebuild */
$('#btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(db,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'taskbones-export.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
$('#fileImport').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const incoming = JSON.parse(text);
    if(!incoming.tasks || !incoming.stats || !incoming.settings) throw new Error('Invalid file');
    if(!confirm('Importing will replace current data. Continue?')) return;
    db = incoming; saveDB(); alert('Import complete.');
  }catch(err){ alert('Import failed: ' + err.message); }
  finally{ e.target.value = ''; }
});
$('#btnReset').addEventListener('click', ()=>{
  if(!confirm('This will erase all data. Continue?')) return;
  db = defaultDB(); saveDB();
});
$('#btnRebuild').addEventListener('click', ()=>{
  const fresh = defaultDB(); fresh.tasks = clone(db.tasks);
  for(const t of fresh.tasks){
    for(const h of (t.history||[])){
      const {cat, pri} = h.snapshot || {cat:t.category, pri:t.priority};
      fresh.stats.totalCompleted += 1;
      fresh.stats.byCategory[cat][pri] += 1;
      fresh.stats.byCategory[cat].score += PRI_WEIGHTS[pri]||1;
    }
    if(t.doneAt && !(t.history||[]).length){
      fresh.stats.totalCompleted += 1;
      fresh.stats.byCategory[t.category][t.priority] += 1;
      fresh.stats.byCategory[t.category].score += PRI_WEIGHTS[t.priority]||1;
    }
  }
  fresh.settings = clone(db.settings);
  db = fresh; saveDB(); alert('Rebuilt stats from history.');
});

/* ========= Boot ========= */
refreshUI();

/* ========= Service Worker (offline) ========= */
if('serviceWorker' in navigator){
  const swCode = `
    const CACHE = 'taskbones-cache-v1';
    const APP_SHELL = ['.'];
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(APP_SHELL)).then(()=>self.skipWaiting()));
    });
    self.addEventListener('activate', e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))) );
      self.clients.claim();
    });
    self.addEventListener('fetch', e=>{
      const req = e.request;
      if(req.method!=='GET'){ return; }
      e.respondWith(
        caches.match(req).then(cached=>{
          const fetcher = fetch(req).then(res=>{
            const copy = res.clone();
            caches.open(CACHE).then(c=>c.put(req, copy));
            return res;
          }).catch(()=>cached);
          return cached || fetcher;
        })
      );
    });
  `;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(console.warn);
}
</script>
</body>
</html>
